# pip install pyserial sounddevice numpy
# [ë…¸íŠ¸ë¶ ì½”ë“œ: Laptop_PassThrough.py]
import serial
import sounddevice as sd
import numpy as np
import struct

# --- ì„¤ì • ---
COM_PORT = 'COM5'      # <--- ì¥ì¹˜ ê´€ë¦¬ì ë³´ê³  ë³¸ì¸ í¬íŠ¸ë¡œ ìˆ˜ì • í•„ìˆ˜!
BAUD_RATE = 115200     # í”¼ì½” USB í†µì‹  ì†ë„ (ì‚¬ì‹¤ USBë¼ ë” ë¹¨ë¼ë„ ë¨)
FS = 16000             # ìƒ˜í”Œë§ ë ˆì´íŠ¸ (ì‹œë¦¬ì–¼ í†µì‹  í•œê³„ë¡œ 44100ì€ ëŠê¸¸ ìˆ˜ ìˆìŒ)
BLOCK_SIZE = 512       # í•œ ë²ˆì— ì²˜ë¦¬í•  ë°ì´í„° ë©ì–´ë¦¬ í¬ê¸°
GAIN = 5.0             # ì†Œë¦¬ ì¦í­ ë°°ìœ¨

# --- ì‹œë¦¬ì–¼ í¬íŠ¸ ì—´ê¸° ---
try:
    ser = serial.Serial(COM_PORT, BAUD_RATE)
    print(f"âœ… {COM_PORT} ì—°ê²° ì„±ê³µ! ë§ˆì´í¬ ì†Œë¦¬ë¥¼ ì§„ë™ìë¡œ ë³´ëƒ…ë‹ˆë‹¤...")
except Exception as e:
    print(f"âŒ í¬íŠ¸ ì—°ê²° ì‹¤íŒ¨: {e}")
    exit()

# --- ì˜¤ë””ì˜¤ ì½œë°± í•¨ìˆ˜ (ì†Œë¦¬ ì¬ìƒìš©) ---
def audio_callback(outdata, frames, time, status):
    if status:
        print(status)
    
    # 1. ì‹œë¦¬ì–¼ì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸° (í•„ìš”í•œ ë°”ì´íŠ¸ ìˆ˜: í”„ë ˆì„ * 2ë°”ì´íŠ¸)
    # í”¼ì½”ê°€ 2ë°”ì´íŠ¸ì”© ë³´ë‚´ë¯€ë¡œ frame * 2 ë§Œí¼ ì½ì–´ì•¼ í•¨
    if ser.in_waiting >= frames * 2:
        raw_data = ser.read(frames * 2)
        
        # 2. ë°”ì´íŠ¸ -> ì •ìˆ˜(0~65535)ë¡œ ë³€í™˜
        # '>H'ëŠ” Big-Endian Unsigned Short (í”¼ì½” ì½”ë“œë‘ ë§ì¶¤)
        # countëŠ” ë°ì´í„° ê°œìˆ˜
        count = len(raw_data) // 2
        ints = struct.unpack(f'>{count}H', raw_data)
        
        # 3. ì •ê·œí™” (0~65535 -> -1.0 ~ 1.0) ë° ì¦í­
        # 32768ì´ ì¤‘ê°„ê°’(0V)ì´ë¼ê³  ê°€ì •
        normalized = [(x - 32768) / 32768.0 * GAIN for x in ints]
        
        # 4. ê¸¸ì´ê°€ ì•ˆ ë§ìœ¼ë©´ 0ìœ¼ë¡œ ì±„ìš°ê±°ë‚˜ ìë¦„ (ì•ˆì „ì¥ì¹˜)
        if len(normalized) < frames:
            normalized += [0.0] * (frames - len(normalized))
        else:
            normalized = normalized[:frames]
            
        # 5. ìŠ¤í…Œë ˆì˜¤ë¡œ ë³€í™˜ (ì™¼ìª½/ì˜¤ë¥¸ìª½ ë˜‘ê°™ì´)í•´ì„œ ì¶œë ¥ ë²„í¼ì— ë‹´ê¸°
        # outdataëŠ” (frames, 2) ëª¨ì–‘ì´ì–´ì•¼ í•¨
        outdata[:] = np.column_stack((normalized, normalized))
        
    else:
        # ë°ì´í„°ê°€ ì•„ì§ ì•ˆ ì™”ìœ¼ë©´ ì¹¨ë¬µ(0) ì¶œë ¥
        outdata.fill(0)

# --- ì¬ìƒ ì‹œì‘ ---
try:
    # ìŠ¤íŠ¸ë¦¼ ì—´ê¸° (OutputStream)
    with sd.OutputStream(channels=2, samplerate=FS, blocksize=BLOCK_SIZE, callback=audio_callback):
        print("ğŸ¤ ì¬ìƒ ì¤‘... (Ctrl+Cë¡œ ì¢…ë£Œ)")
        print("ë§ˆì´í¬ì— ì†Œë¦¬ë¥¼ ë‚´ë³´ì„¸ìš”!")
        while True:
            sd.sleep(1000)

except KeyboardInterrupt:
    print("\nì¢…ë£Œí•©ë‹ˆë‹¤.")
    ser.close()
except Exception as e:
    print(f"\nì—ëŸ¬ ë°œìƒ: {e}")
    ser.close()
